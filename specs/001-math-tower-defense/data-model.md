# Data Model: Math Tower Defense Game

**Purpose**: Define game entities, their properties, relationships, and state transitions  
**Created**: 2025-11-22  
**Feature**: Math Tower Defense Game

## Core Entities

### GameSession

**Description**: Central state container that persists across scenes throughout a single play session.

**Properties**:
- `grade: number` - Selected grade level (0-3)
- `coins: number` - Current coin balance
- `currentWave: number` - Wave number (1-5)
- `baseHealth: number` - Base health points (starts at 10)
- `placedTowers: PlacedTowerData[]` - Array of tower placements
- `problemsSolved: number` - Count of correctly answered problems this wave
- `totalScore: number` - Accumulated score across all waves

**Relationships**:
- **Contains**: Array of PlacedTowerData
- **Referenced by**: All game scenes for state access

**State Transitions**:
```
INITIAL (grade=0, coins=0, wave=1, baseHealth=10)
  ↓ [grade selected in GradeSelection]
GRADE_SELECTED (grade=0-3)
  ↓ [problems solved in MathChallenge]
COINS_EARNED (coins += rewards)
  ↓ [5 problems solved]
READY_FOR_DEFENSE
  ↓ [towers placed in TowerPlacement]
TOWERS_PLACED
  ↓ [defense wave completed]
WAVE_COMPLETE (wave++, coins += bonus)
  ↓ [repeat until wave=5 OR baseHealth=0]
GAME_OVER (victory or defeat)
```

**Validation Rules**:
- Grade must be 0-3
- Coins cannot be negative
- Wave must be 1-5
- Base health must be 0-10

---

### MathProblem

**Description**: A math question with one correct answer and three distractor answers.

**Properties**:
- `id: string` - Unique identifier
- `question: string` - Display text (e.g., "5 + 3 = ?")
- `correctAnswer: number` - The correct solution
- `distractors: number[]` - Array of 3 incorrect answers
- `grade: number` - Grade level this problem is appropriate for (0-3)
- `difficulty: number` - Difficulty within grade (1-3, increases with wave)
- `operation: 'add' | 'subtract' | 'multiply' | 'divide'` - Math operation type
- `attempts: number` - Number of times user has attempted this problem

**Relationships**:
- **Generated by**: MathProblemGenerator
- **Displayed in**: MathChallenge scene
- **Referenced by**: GameSession (tracking solved count)

**State Transitions**:
```
GENERATED (attempts=0)
  ↓ [user selects answer]
ATTEMPTED (attempts++)
  ↓ [correct answer selected]
SOLVED (coins awarded)
  OR
  ↓ [incorrect answer, attempts < 3]
RETRY (show "Prøv igen!")
  OR
  ↓ [incorrect answer, attempts = 3]
REVEALED (show correct answer, no coins)
```

**Validation Rules**:
- All answers (correct + distractors) must be unique
- Distractors must be plausible (within ±5 of correct answer)
- Question must be grade-appropriate
- Attempts cannot exceed 3

---

### Tower (Base Class)

**Description**: Defensive structure that automatically targets and shoots enemies.

**Properties**:
- `id: string` - Unique identifier
- `type: TowerType` - Tower variant (basic/rapid/area)
- `position: GridPosition` - Grid coordinates {row, col}
- `cost: number` - Purchase price in coins
- `attackDamage: number` - Damage per hit
- `attackRange: number` - Range in pixels
- `fireRate: number` - Milliseconds between shots
- `level: number` - Upgrade level (1-2)
- `target: Zombie | null` - Currently targeted enemy
- `lastFired: number` - Timestamp of last shot
- `sprite: Phaser.GameObjects.Sprite` - Visual representation

**Relationships**:
- **Placed on**: GridCell
- **Targets**: Zombie
- **Fires**: Projectile
- **Owned by**: GameSession (via placedTowers array)

**State Transitions**:
```
PURCHASABLE (in tower shop)
  ↓ [user buys and places]
PLACED (active on grid)
  ↓ [zombie enters range]
TARGETING (target set)
  ↓ [fire rate elapsed]
FIRING (projectile created)
  ↓ [target destroyed or leaves range]
IDLE (target = null)
  ↓ [user clicks with sufficient coins]
UPGRADED (level++, stats improved)
  ↓ [wave ends]
CARRIED_OVER (persists to next wave)
  ↓ [base health = 0]
DESTROYED (removed from game)
```

**Validation Rules**:
- Can only be placed on empty grid cells
- Cost must be <= available coins
- Level cannot exceed 2
- Fire rate must be > 0
- Attack range must cover at least 2 grid cells

**Subtypes**:

#### BasicTower
- Cost: 50 coins
- Damage: 2
- Range: 150px
- Fire rate: 1000ms
- Special: None (standard single-target tower)

#### RapidTower
- Cost: 100 coins
- Damage: 1
- Range: 120px
- Fire rate: 500ms
- Special: High fire rate for sustained DPS

#### AreaTower
- Cost: 150 coins
- Damage: 3
- Range: 180px
- Fire rate: 1500ms
- Special: Area damage (affects all zombies within 128px of impact)

---

### Zombie

**Description**: Enemy entity that follows a predetermined path toward the base.

**Properties**:
- `id: string` - Unique identifier
- `health: number` - Current hit points
- `maxHealth: number` - Maximum hit points
- `speed: number` - Movement speed in pixels/second
- `pathProgress: number` - Distance traveled along path (0-1, where 1 = reached base)
- `position: {x, y}` - Current screen coordinates
- `damageToBase: number` - Damage dealt when reaching base (always 1)
- `sprite: Phaser.GameObjects.Sprite` - Visual representation
- `healthBar: Phaser.GameObjects.Graphics` - HP indicator

**Relationships**:
- **Spawned by**: WaveManager
- **Follows**: Path (defined in levelLayout)
- **Targeted by**: Tower
- **Hit by**: Projectile
- **Damages**: Base (on reaching end of path)

**State Transitions**:
```
SPAWNED (health = maxHealth, pathProgress = 0)
  ↓ [movement update each frame]
MOVING (pathProgress increases)
  ↓ [projectile hits]
HIT (health -= damage)
  ↓ [health > 0]
CONTINUE_MOVING
  OR
  ↓ [health <= 0]
DESTROYED (removed, no base damage)
  ↓ [pathProgress >= 1]
REACHED_BASE (baseHealth--, zombie removed)
```

**Validation Rules**:
- Health must be 0 to maxHealth
- Speed must be > 0
- Path progress must be 0-1
- Damage to base is always 1

**Scaling by Wave**:
```
Wave 1: health=5, speed=50px/s
Wave 2: health=6, speed=50px/s
Wave 3: health=7, speed=50px/s
Wave 4: health=8, speed=55px/s
Wave 5: health=9, speed=60px/s
```

---

### Projectile (Base Class)

**Description**: Ammunition fired by towers that travels to target and deals damage.

**Properties**:
- `id: string` - Unique identifier
- `type: 'bullet' | 'explosion'` - Projectile variant
- `damage: number` - Damage dealt on hit
- `speed: number` - Travel speed in pixels/second
- `target: Zombie` - Target enemy
- `position: {x, y}` - Current screen coordinates
- `sprite: Phaser.GameObjects.Sprite` - Visual representation

**Relationships**:
- **Fired by**: Tower
- **Travels toward**: Zombie
- **Hits**: Zombie (or zombies if area effect)
- **Pooled in**: DefenseWave scene projectile pool

**State Transitions**:
```
POOLED (inactive, waiting for reuse)
  ↓ [tower fires]
ACTIVE (flying toward target)
  ↓ [reaches target position]
HIT (apply damage)
  ↓ [damage applied]
RETURNED_TO_POOL (inactive)
  OR
  ↓ [target destroyed mid-flight]
MISSED (returned to pool)
```

**Validation Rules**:
- Damage must be > 0
- Speed must be > 0
- Target must be valid and active

**Subtypes**:

#### BulletProjectile
- Used by: BasicTower, RapidTower
- Behavior: Single-target, direct damage

#### AreaProjectile
- Used by: AreaTower
- Behavior: Explodes on impact, damages all zombies within radius
- Explosion radius: 128px

---

### GridCell

**Description**: Single unit in the 2D grid representing placeable space, path, or base.

**Properties**:
- `type: CellType` - Cell category (empty/occupied/path/base)
- `position: GridPosition` - Grid coordinates {row, col}
- `tower: Tower | null` - Placed tower (if occupied)
- `screenPosition: {x, y}` - Center point in pixels
- `sprite: Phaser.GameObjects.Rectangle` - Visual representation

**Relationships**:
- **Contained in**: Grid
- **May contain**: Tower
- **Part of**: Path (if type === CellType.Path)

**State Transitions**:
```
EMPTY (type=CellType.Empty, tower=null)
  ↓ [tower placed]
OCCUPIED (type=CellType.Occupied, tower set)
  ↓ [tower sold/removed - future feature]
EMPTY

PATH (type=CellType.Path) - immutable, no transitions
BASE (type=CellType.Base) - immutable, no transitions
```

**Validation Rules**:
- Path and Base cells cannot have towers
- Occupied cells must have tower reference
- Empty cells must have tower = null

---

### Grid

**Description**: 2D grid system managing cell layout and tower placement.

**Properties**:
- `rows: number` - Grid height (e.g., 10)
- `cols: number` - Grid width (e.g., 15)
- `cellSize: number` - Cell dimensions in pixels (e.g., 64)
- `cells: GridCell[][]` - 2D array of grid cells
- `path: GridPosition[]` - Ordered array defining zombie path
- `spawnPoint: GridPosition` - Where zombies spawn
- `basePoint: GridPosition` - Base location (zombie goal)

**Relationships**:
- **Contains**: Array of GridCell
- **Defines**: Path for zombie movement
- **Used by**: TowerPlacement scene for placement validation
- **Used by**: DefenseWave scene for path finding

**Methods** (conceptual, for implementation):
- `isValidPlacement(row, col): boolean` - Check if tower can be placed
- `getTowerAt(row, col): Tower | null` - Get tower at position
- `placeTower(row, col, tower): void` - Place tower and update cell
- `screenToGrid(x, y): GridPosition` - Convert screen to grid coordinates
- `gridToScreen(row, col): {x, y}` - Convert grid to screen coordinates

**Validation Rules**:
- Path must be continuous from spawn to base
- Spawn and base points must be on grid boundaries
- Path cells cannot overlap with empty/occupied cells (different cell type)

---

### WaveConfig

**Description**: Configuration for a single defense wave defining enemy composition and rewards.

**Properties**:
- `waveNumber: number` - Wave identifier (1-5)
- `zombieCount: number` - Number of zombies to spawn
- `zombieHealth: number` - HP per zombie
- `zombieSpeed: number` - Movement speed
- `spawnInterval: number` - Milliseconds between zombie spawns
- `coinRewardPerProblem: number` - Coins earned per correct math answer
- `bonusCoins: number` - Coins awarded for completing wave

**Relationships**:
- **Used by**: WaveManager for spawning
- **Used by**: MathChallenge for coin rewards
- **Generated by**: Wave config calculator (based on wave number)

**Scaling Formula**:
```typescript
waveNumber: n (1-5)
zombieCount: floor(5 * 1.2^(n-1))
zombieHealth: 5 + (n-1)
zombieSpeed: n >= 4 ? 50 * (1 + (n-3) * 0.1) : 50
spawnInterval: 2000ms (constant)
coinRewardPerProblem: 10 + (n-1) * 5
bonusCoins: 25 (constant)
```

---

### Base

**Description**: Player's objective that zombies attack.

**Properties**:
- `health: number` - Current health points (0-10)
- `maxHealth: number` - Maximum health (10)
- `position: GridPosition` - Grid location
- `sprite: Phaser.GameObjects.Sprite` - Visual representation

**Relationships**:
- **Damaged by**: Zombie (when zombie reaches it)
- **Protected by**: Towers
- **Referenced by**: GameSession (baseHealth)

**State Transitions**:
```
FULL_HEALTH (health = 10)
  ↓ [zombie reaches base]
DAMAGED (health--)
  ↓ [repeat until health = 0]
DESTROYED (game over, defeat)
  ↓ [wave completes with health > 0]
SURVIVES (continue to next wave)
```

**Validation Rules**:
- Health must be 0-10
- Health cannot increase (no healing in MVP)
- Health = 0 triggers game over

---

## Entity Relationships Diagram

```
GameSession
├── grade (0-3)
├── coins
├── currentWave (1-5)
├── baseHealth (0-10)
└── placedTowers[]
    └── PlacedTowerData {type, position}

MathProblemGenerator
└── generates → MathProblem[]
    └── displayed in → MathChallenge scene

Grid
├── cells[][]
│   └── GridCell
│       ├── may contain → Tower
│       └── defines type → CellType
├── path[] → GridPosition[]
└── used by → DefenseWave for pathfinding

Tower (BasicTower | RapidTower | AreaTower)
├── placed on → GridCell
├── targets → Zombie
└── fires → Projectile
    └── hits → Zombie

WaveManager
└── spawns → Zombie[]
    ├── follows → path (from Grid)
    ├── targeted by → Tower[]
    └── damages → Base (if reaches end)

Base
├── damaged by → Zombie
└── health tracked in → GameSession.baseHealth
```

---

## Data Flow

### Grade Selection → Math Challenge
```
1. User selects grade (0-3) in GradeSelection scene
2. GameSession.grade = selectedGrade
3. Scene transitions to MathChallenge with grade data
4. MathProblemGenerator uses grade to determine problem difficulty
5. 5 problems generated and presented sequentially
6. Correct answers award coins (GameSession.coins += reward)
7. After 5 problems, scene transitions to TowerPlacement
```

### Math Challenge → Tower Placement
```
1. MathChallenge scene completes with coins earned
2. GameSession.coins updated
3. Scene transitions to TowerPlacement with coin total
4. TowerPlacement displays tower shop with prices
5. User purchases towers (GameSession.coins -= cost)
6. Towers placed on grid (GameSession.placedTowers updated)
7. User clicks "Start Bølge" → transitions to DefenseWave
```

### Tower Placement → Defense Wave
```
1. TowerPlacement scene ends with towers placed
2. GameSession.placedTowers contains tower data
3. Scene transitions to DefenseWave
4. DefenseWave reconstructs towers from placedTowers data
5. WaveManager spawns zombies based on WaveConfig
6. Combat loop: towers target → fire projectiles → hit zombies
7. Zombies destroyed or reach base (base Health--)
8. Wave completes → bonus coins awarded
9. If baseHealth > 0, transition back to MathChallenge for next wave
10. If baseHealth = 0 OR wave = 5, transition to GameOver
```

---

## State Persistence

**Between Scenes**:
- GameSession singleton maintains state
- placedTowers array persists tower placements across waves
- Towers from previous waves remain active in subsequent defense waves

**Within Wave Cycle**:
```
Wave 1: Math (5 problems) → Placement → Defense
Wave 2: Math (5 problems) → Placement (existing towers + new) → Defense
Wave 3: Math (5 problems) → Placement (existing towers + new) → Defense
Wave 4: Math (5 problems) → Placement (existing towers + new) → Defense
Wave 5: Math (5 problems) → Placement (existing towers + new) → Defense → Victory/Defeat
```

**No Persistence**:
- Game state resets on game over (per spec assumptions)
- No save/load system in MVP
- No high score tracking across sessions

---

## Type Definitions Summary

```typescript
// Core enums
enum CellType { Empty, Occupied, Path, Base }
enum TowerType { Basic, Rapid, Area }
enum GamePhase { GradeSelection, MathChallenge, TowerPlacement, DefenseWave, GameOver }

// Position types
interface GridPosition { row: number; col: number; }
interface ScreenPosition { x: number; y: number; }

// Entity data types
interface PlacedTowerData {
  type: TowerType;
  position: GridPosition;
  level: number;
}

interface MathProblemData {
  question: string;
  correctAnswer: number;
  allAnswers: number[]; // shuffled correct + distractors
}

interface WaveConfigData {
  waveNumber: number;
  zombieCount: number;
  zombieStats: { health: number; speed: number; };
  rewards: { perProblem: number; bonus: number; };
}
```
