# Phase 1: Data Model

**Feature**: PR Preview Deployment System  
**Date**: 2025-11-23

## Entity Definitions

### 1. Deployment Artifact

**Description**: A directory structure uploaded to GitHub Pages containing static website files.

**Structure**:
```
deployment-artifact/
├── index.html              # Game entry point (main branch)
├── style.css               # Styles (main branch)
├── assets/                 # Game assets (main branch)
│   ├── bg.png
│   ├── logo.png
│   └── [bundled JS chunks]
└── preview/               # Preview subdirectory (PR branch)
    ├── index.html
    ├── style.css
    └── assets/
        ├── bg.png
        ├── logo.png
        └── [bundled JS chunks]
```

**Properties**:
- **Root Level**: Always contains main branch build output
- **Preview Subdirectory**: Optional, contains PR branch build output (present only in PR deployments)
- **Size Constraint**: Total artifact must be <1GB (GitHub Pages limit)
- **Lifespan**: Replaced completely on each deployment

**Variants**:
- **Production Artifact**: Root level only, no `preview/` folder
- **Preview Artifact**: Root level + `preview/` subdirectory

---

### 2. Workflow Context

**Description**: Runtime information available to GitHub Actions workflows from the triggering event.

**Properties**:
- `github.ref`: Full git reference (e.g., `refs/heads/main`, `refs/heads/feature-branch`)
- `github.ref_name`: Short branch name (e.g., `main`, `feature-branch`)
- `github.event_name`: Event type (`push`, `pull_request`, `workflow_dispatch`)
- `github.sha`: Commit SHA triggering the workflow
- `github.repository`: Repository in `owner/repo` format

**Usage**: Determines deployment type based on `github.ref_name`:
- If `main` → Production deployment
- If not `main` → Preview deployment

**Availability**: Present in all workflow runs (PR events, pushes, manual triggers)

---

### 3. Build Output

**Description**: Compiled game assets generated by `npm run build-nolog` command.

**Location**: `dist/` directory (Vite default output)

**Contents**:
```
dist/
├── index.html              # Entry point with inlined CSS links and script tags
├── style.css               # Global styles
├── assets/                 # Bundled and optimized assets
│   ├── [hash].js          # Main game bundle
│   ├── phaser-[hash].js   # Phaser framework (code-split)
│   ├── bg.png             # Static assets
│   └── logo.png
└── favicon.png             # (if present)
```

**Properties**:
- **Build Command**: `npm run build-nolog` (production optimized)
- **Build Time**: ~30-60 seconds per branch
- **Size**: ~5-10 MB per build (compressed)
- **Path References**: Relative paths (`./`) for subdirectory compatibility

**Lifecycle**: 
1. Created during workflow build step
2. Copied to combined artifact directory
3. Discarded after upload

---

### 4. Workflow Job

**Description**: A single unit of work within a GitHub Actions workflow.

**Types**:

**Build Job**:
- **Purpose**: Compile game assets for specified branch
- **Runs On**: `ubuntu-latest`
- **Steps**: Checkout → Setup Node → Install deps → Build
- **Outputs**: Build artifact stored in `dist/`
- **Duration**: ~2-3 minutes

**Deploy Job**:
- **Purpose**: Upload combined artifact to GitHub Pages
- **Runs On**: `ubuntu-latest`
- **Dependencies**: Requires build job(s) completion
- **Steps**: Create combined structure → Upload → Deploy
- **Outputs**: Deployment URL
- **Duration**: ~1-2 minutes

**Relationship**: Deploy job waits for build job(s) completion via `needs:` dependency.

---

### 5. Concurrency Group

**Description**: GitHub Actions mechanism to control simultaneous workflow executions.

**Configuration**:

**PR Preview Workflow**:
```yaml
concurrency:
  group: "pages-preview"
  cancel-in-progress: true
```
- **Group Name**: `pages-preview` (all PR deployments)
- **Behavior**: New deployment cancels running deployments
- **Rationale**: Only latest preview matters, save CI resources

**Main Deployment Workflow**:
```yaml
concurrency:
  group: "pages"
  cancel-in-progress: false
```
- **Group Name**: `pages` (production deployments)
- **Behavior**: Queue deployments, ensure completion
- **Rationale**: Production stability, no partial deployments

---

## State Machine: Deployment Lifecycle

### States

1. **Idle**: No deployment in progress
2. **Building**: Compiling game assets
3. **Combining**: Merging build outputs
4. **Uploading**: Creating Pages artifact
5. **Deploying**: Activating on GitHub Pages
6. **Active**: Deployment live and accessible
7. **Failed**: Error occurred, deployment aborted

### Transitions

```
[Workflow Triggered]
    ↓
[Building]
    ↓ (build success)
[Combining] ← (if preview deployment, combine main + PR)
    ↓ (validation pass)
[Uploading]
    ↓ (artifact created)
[Deploying]
    ↓ (Pages activated)
[Active]

    ↓ (any step fails)
[Failed] → (manual retry or new commit)

    ↓ (new deployment triggered)
[Idle] → (entire site replaced, previous deployment gone)
```

### Special Cases

**Main Build Failure During PR Deployment**:
```
[Building Main] → FAIL
    ↓
[Fetch Cached Main Artifact] (if available)
    ↓
[Log Warning]
    ↓
[Building PR] → SUCCESS
    ↓
[Combining with Cached Main]
    ↓
[Continue normal flow with warning status]
```

**Concurrent PR Deployment**:
```
[PR Deployment 1: Building]
    ↓
[PR Deployment 2: Triggered] → [Cancel Deployment 1]
    ↓
[PR Deployment 2: Building] → becomes active deployment
```

---

## Data Flow Diagram

### PR Preview Deployment Flow

```
┌─────────────────────────────────────────────────────────────┐
│                     Workflow Trigger                        │
│              (PR opened/sync OR workflow_dispatch)          │
└─────────────────────────────────────────────────────────────┘
                              ↓
                    ┌─────────────────┐
                    │ Check Branch    │
                    │ github.ref_name │
                    └─────────────────┘
                              ↓
                ┌─────────────┴─────────────┐
                ↓                           ↓
        [Is "main"?]                  [Not "main"]
                ↓                           ↓
    ┌────────────────────┐      ┌──────────────────────┐
    │ Production Deploy  │      │  Preview Deploy      │
    │                    │      │                      │
    │ 1. Build main      │      │ 1. Build main        │
    │ 2. Upload dist/    │      │ 2. Build PR branch   │
    │ 3. Deploy          │      │ 3. Combine:          │
    │                    │      │    - dist-main/ → /  │
    │                    │      │    - dist-pr/ → /preview/ │
    │                    │      │ 4. Upload combined/  │
    │                    │      │ 5. Deploy            │
    └────────────────────┘      └──────────────────────┘
                ↓                           ↓
    ┌────────────────────────────────────────────────────┐
    │           GitHub Pages Deployment                  │
    │  (Replaces entire site with new artifact)         │
    └────────────────────────────────────────────────────┘
                ↓
    ┌────────────────────────────────────────────────────┐
    │           Accessible URLs                          │
    │  - Production: /{owner}.github.io/{repo}/          │
    │  - Preview: /{owner}.github.io/{repo}/preview/     │
    └────────────────────────────────────────────────────┘
```

### Main Branch Deployment Flow (Cleanup)

```
┌─────────────────────────────────────────────────────────────┐
│              Main Branch Push/Merge                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
                    ┌─────────────────┐
                    │ Build main      │
                    │ Output: dist/   │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │ Validate dist/  │
                    │ (no preview/)   │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │ Upload artifact │
                    └─────────────────┘
                              ↓
                    ┌─────────────────┐
                    │ Deploy to Pages │
                    │ (Overwrites all)│
                    └─────────────────┘
                              ↓
         ┌────────────────────────────────────┐
         │ Result: Only production at root    │
         │ No /preview/ folder exists         │
         └────────────────────────────────────┘
```

---

## Directory Structure Relationships

### Workflow Perspective

```
Repository Root
├── .github/workflows/
│   ├── deploy-main.yml          [Watches main branch]
│   │                            [Triggers on push to main]
│   │                            [Produces: production artifact]
│   │
│   └── deploy-pr-preview.yml    [Watches PRs + manual triggers]
│                                [Triggers on: PR events, workflow_dispatch]
│                                [Produces: preview artifact]
│
├── dist-main/                   [Temporary: Main build output]
│   └── [Build output from main branch]
│
├── dist-pr/                     [Temporary: PR build output]
│   └── [Build output from PR branch]
│
└── combined/                    [Temporary: Merged for upload]
    ├── [Main content at root]
    └── preview/
        └── [PR content in subdirectory]
```

### GitHub Pages Perspective

```
GitHub Pages Site
├── /                            [Always from main branch]
│   ├── index.html
│   ├── style.css
│   └── assets/
│
└── /preview/                    [Only present if last deployment was PR]
    ├── index.html
    ├── style.css
    └── assets/
```

---

## Validation Rules

### Artifact Validation

**Before Upload**:
1. `index.html` must exist at root
2. `assets/` directory must contain bundled JS
3. Total size must be <1GB
4. If preview deployment, `preview/index.html` must exist

**After Deployment**:
1. Root URL returns 200 status
2. If preview, `/preview/` URL returns 200 status
3. Assets load without 404 errors

### Build Output Validation

**Per Build**:
1. `dist/` directory exists after build
2. `dist/index.html` contains valid HTML
3. Build command exits with code 0
4. No critical Vite errors in logs

---

## Entity Relationships

```
Workflow Trigger (1) ──triggers──> (1) Workflow Run
                                        │
                                        │ contains
                                        ↓
                                  (1+) Workflow Job
                                        │
                                        │ produces
                                        ↓
                                  (1+) Build Output
                                        │
                                        │ combined into
                                        ↓
                                  (1) Deployment Artifact
                                        │
                                        │ deployed to
                                        ↓
                                  (1) GitHub Pages Site
                                        │
                                        │ serves at
                                        ↓
                                  (1+) URL Endpoint
```

---

## Constitution Alignment

**Scene-Based Architecture**: ✅ N/A - No game code changes  
**Bilingual Implementation**: ✅ Workflow YAML in English (standard)  
**Test-Driven Development**: ✅ Existing Playwright tests validate deployments  
**CI/CD Pipeline**: ✅ Implements documented preview system  
**Type Safety & Build**: ✅ No changes to build configuration

---

## Next Steps → Contracts

✅ Data model complete - entity relationships defined  
→ Proceed to create workflow contracts
