name: Deploy PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests
      run: npm run test

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-pr-${{ github.event.number }}
        path: playwright-report/
        retention-days: 30

  build-and-deploy-preview:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build-nolog

    - name: Clone gh-pages branch
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Clone the repository with gh-pages branch
        git clone --single-branch --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages-repo || \
        git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages-repo
        
        cd gh-pages-repo
        
        # Create gh-pages branch if it doesn't exist
        git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages
        
        # Remove existing preview folder if it exists
        rm -rf preview/pr-${{ github.event.number }} || true
        
        # Create preview directory structure
        mkdir -p preview/pr-${{ github.event.number }}

    - name: Copy built files to preview directory
      run: |
        cp -r dist/* gh-pages-repo/preview/pr-${{ github.event.number }}/

    - name: Update preview index
      run: |
        cd gh-pages-repo
        
        # Create or update the preview index file
        cat > preview/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>PR Previews - Mission Kritisk</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                .preview-item { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                .preview-item a { color: #0066cc; text-decoration: none; font-weight: bold; }
                .preview-item a:hover { text-decoration: underline; }
                .pr-number { color: #666; font-size: 0.9em; }
            </style>
        </head>
        <body>
            <h1>PR Previews - Mission Kritisk</h1>
            <div class="preview-item">
                <a href="pr-${{ github.event.number }}/">PR #${{ github.event.number }} Preview</a>
                <div class="pr-number">Latest deployment: $(date)</div>
            </div>
            <p><a href="../">‚Üê Back to main site</a></p>
        </body>
        </html>
        EOF

    - name: Deploy preview
      run: |
        cd gh-pages-repo
        
        git add .
        
        if git diff --staged --quiet; then
          echo "No changes to deploy"
          exit 0
        fi
        
        git commit -m "Deploy PR #${{ github.event.number }} preview"
        git push origin gh-pages

    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const repoName = context.repo.repo;
          const owner = context.repo.owner;
          
          const previewUrl = `https://${owner}.github.io/${repoName}/preview/pr-${prNumber}/`;
          
          const comment = `## üöÄ Preview Deployment
          
          Your PR has been deployed to a preview environment:
          
          **Preview URL:** ${previewUrl}
          
          The preview will be updated automatically when you push new commits to this PR.
          
          **Test Results:** Check the Actions tab for Playwright test results.`;
          
          // Try to update existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner,
            repo: repoName,
            issue_number: prNumber,
          });
          
          const existingComment = comments.find(comment => 
            comment.user.login === 'github-actions[bot]' && 
            comment.body.includes('Preview Deployment')
          );
          
          if (existingComment) {
            await github.rest.issues.updateComment({
              owner,
              repo: repoName,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner,
              repo: repoName,
              issue_number: prNumber,
              body: comment
            });
          }